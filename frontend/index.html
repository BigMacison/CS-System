<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WebUI Frontend</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: black;
      color: white;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 250px;
      background: #111;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    .dropdown-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    select {
      flex: 1;
      padding: 8px;
      background-color: #222;
      color: white;
      border: none;
      border-radius: 4px;
      appearance: none;
    }
    .add-btn {
      width: 30px;
      height: 30px;
      margin-left: 5px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      line-height: 30px;
      text-align: center;
      cursor: pointer;
    }
    .section > button {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .section > button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .predefined-inputs {
      flex: 1;
      overflow-y: auto;
      border-top: 1px dashed #555;
      padding-top: 10px;
      margin-bottom: 10px;
    }
    .predefined-inputs button {
      width: 100%;
      margin-bottom: 5px;
      padding: 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .predefined-inputs button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #terminal-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    #terminal {
      flex: 1;
      background: black;
      padding: 10px;
      overflow-y: auto;
      font-family: monospace;
      border-bottom: 1px solid #444;
    }
    #input-bar {
      display: flex;
    }
    #input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      font-family: monospace;
    }
    #send {
      background: #444;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #000;
      z-index: 1000;
      transition: opacity 0.3s ease;
      max-width: 300px;
    }
    .toast.hidden {
      display: none;
    }
    .notif-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #222;
      color: white;
      border: none;
      border-radius: 50%;
      padding: 10px 12px;
      font-size: 18px;
      z-index: 1100;
      cursor: pointer;
    }
    .notif-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 300px;
      max-height: 70vh;
      overflow-y: auto;
      background: #111;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 10px;
      z-index: 1050;
    }
    .notif-panel.hidden {
      display: none;
    }
    .notif-panel h3 {
      margin-top: 0;
      color: #aaa;
    }
    .notification-item {
      background: #222;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      color: white;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-window {
      background-color: #1a1a1a;
      color: white;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      box-shadow: 0 0 20px #000;
      max-height: 80vh;
      overflow-y: auto;
    }
    .hidden {
      display: none;
    }
    .modal-window label {
      display: block;
      margin-bottom: 4px;
    }
    .modal-window input, .modal-window select, .modal-window textarea {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #222;
      color: #fff;
      margin-bottom: 10px;
    }
    .modal-window textarea {
      height: 200px;
      resize: vertical;
    }
    .command-section, .argument-section {
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      background-color: #222;
    }
    .command-section h4, .argument-section h4 {
      margin: 0 0 10px 0;
      color: #aaa;
    }
    .add-btn-small {
      background-color: #333;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      margin-top: 5px;
    }
    .remove-btn {
      background-color: #cc0000;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      margin-left: 5px;
    }
    .delete-btn, .maintenance-btn {
      width: 100%;
      padding: 10px;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .delete-btn {
      background: #cc0000;
    }
    .maintenance-btn {
      background: #0066cc;
    }
    .delete-btn:disabled, .maintenance-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<!-- Sidebar -->
<div id="sidebar">
  <div class="dropdown-row">
    <select id="endpointSelect"></select>
    <button class="add-btn" onclick="openEndpointCreateModal()">+</button>
  </div>
  <div class="dropdown-row">
    <select id="serverSelect"></select>
    <button id="serverAddBtn" class="add-btn" onclick="openServerCreateModal()">+</button>
  </div>
  <div class="section">
    <button id="startStopBtn" onclick="onClick('Start/Stop')">Start</button>
    <button id="configureBtn" onclick="openServerConfigModal()">Configure</button>
  </div>
  <div class="predefined-inputs" id="predefinedInputs"></div>
  <button id="maintenanceBtn" class="maintenance-btn">Maintenance</button>
  <button id="deleteServerBtn" class="delete-btn" onclick="confirmDeleteServer()">Delete Server</button>
</div>
<!-- Terminal -->
<div id="terminal-container">
  <div id="terminal"></div>
  <div id="input-bar">
    <input id="input" placeholder="Input" />
    <button id="send">Send</button>
  </div>
</div>
<!-- Notifications -->
<div id="notificationToast" class="toast hidden"></div>
<button id="toggleNotifications" class="notif-toggle">üîî</button>
<div id="notificationPanel" class="notif-panel hidden">
  <h3>Alle Benachrichtigungen</h3>
  <div id="notificationList"></div>
</div>
<!-- Config Modal -->
<div id="configModalOverlay" class="modal-overlay hidden">
  <div class="modal-window">
    <h2>Server konfigurieren</h2>
    <form id="serverConfigForm">
      <label for="serverConfigStartCmdWin">Start Command (Windows)</label>
      <input type="text" id="serverConfigStartCmdWin" name="start_cmd_win">

      <label for="serverConfigStartCmdLinux">Start Command (Linux)</label>
      <input type="text" id="serverConfigStartCmdLinux" name="start_cmd_linux">

      <label for="serverConfigStopCmd">Stop Command</label>
      <input type="text" id="serverConfigStopCmd" name="stop_cmd">

      <label for="serverConfigPort">Port</label>
      <input type="number" id="serverConfigPort" name="port" required>

      <label for="serverConfigEnv">Environment (JSON)</label>
      <textarea id="serverConfigEnv" name="env" placeholder='{"key": "value"}'></textarea>

      <h3>Commands</h3>
      <div id="serverConfigCommands"></div>
      <button type="button" class="add-btn-small" onclick="addCommandSection('serverConfigCommands')">+ Command</button>

      <div style="text-align: right; margin-top: 10px;">
        <button type="button" id="serverConfigCancel" style="margin-right: 10px;">Abbrechen</button>
        <button type="submit" id="serverConfigSubmit">Speichern</button>
      </div>
    </form>
  </div>
</div>
<!-- Argument Modal -->
<div id="argumentModalOverlay" class="modal-overlay hidden">
  <div class="modal-window" id="argumentModal">
    <h2 id="argumentModalTitle">Befehl ausf√ºhren</h2>
    <form id="argumentForm">
      <!-- Inputs will be dynamically added here -->
    </form>
    <div style="text-align: right; margin-top: 10px;">
      <button id="argumentCancel" type="button" style="margin-right: 10px;">Abbrechen</button>
      <button id="argumentSubmit" type="submit">Ausf√ºhren</button>
    </div>
  </div>
</div>
<!-- Server Create Modal -->
<div id="serverCreateModalOverlay" class="modal-overlay hidden">
  <div class="modal-window">
    <h2>Neuen Server erstellen</h2>
    <form id="serverCreateForm">
      <label for="serverCreateEndpoint">Endpoint</label>
      <select id="serverCreateEndpoint" name="endpoint" required></select>

      <label for="serverCreateName">Server Name</label>
      <input type="text" id="serverCreateName" name="server_name" required>

      <label for="serverCreateStartCmdWin">Start Command (Windows)</label>
      <input type="text" id="serverCreateStartCmdWin" name="start_cmd_win">

      <label for="serverCreateStartCmdLinux">Start Command (Linux)</label>
      <input type="text" id="serverCreateStartCmdLinux" name="start_cmd_linux">

      <label for="serverCreateStopCmd">Stop Command</label>
      <input type="text" id="serverCreateStopCmd" name="stop_cmd">

      <label for="serverCreatePort">Port</label>
      <input type="number" id="serverCreatePort" name="port" required>

      <label for="serverCreateEnv">Environment (JSON)</label>
      <textarea id="serverCreateEnv" name="env" placeholder='{"key": "value"}'></textarea>

      <h3>Commands</h3>
      <div id="serverCreateCommands"></div>
      <button type="button" class="add-btn-small" onclick="addCommandSection('serverCreateCommands')">+ Command</button>

      <div style="text-align: right; margin-top: 10px;">
        <button type="button" id="serverCreateCancel" style="margin-right: 10px;">Abbrechen</button>
        <button type="submit" id="serverCreateSubmit">Erstellen</button>
      </div>
    </form>
  </div>
</div>
<!-- Endpoint Create Modal -->
<div id="endpointCreateModalOverlay" class="modal-overlay hidden">
  <div class="modal-window">
    <h2>Rclone-Konfiguration hinzuf√ºgen</h2>
    <form id="endpointCreateForm">
      <label for="endpointCreateConfig">Rclone-Konfiguration f√ºr Endpunkte einf√ºgen</label>
      <textarea id="endpointCreateConfig" name="config" placeholder="[meinremote]\ntype = drive\nclient_id = abc\nclient_secret = def" required></textarea>

      <div style="text-align: right; margin-top: 10px;">
        <button type="button" id="endpointCreateCancel" style="margin-right: 10px;">Abbrechen</button>
        <button type="submit" id="endpointCreateSubmit">Hinzuf√ºgen</button>
      </div>
    </form>
  </div>
</div>
<!-- Script -->
<script>
  const terminal = document.getElementById("terminal");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  let ws;
  let maintenanceMode = false;
  let ongoingTransfers = {}; // Tracks ongoing upload/download notifications

  function addToTerminal(text, autoScroll = false) {
    const atBottom = terminal.scrollTop + terminal.clientHeight >= terminal.scrollHeight - 5;
    const element = document.createElement("div");
    element.textContent = text;
    terminal.appendChild(element);
    if (autoScroll || atBottom) terminal.scrollTop = terminal.scrollHeight;
  }

  async function sendInputToServer(inputString) {
    try {
      const res = await fetch("/server/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ input: inputString })
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (data.status !== "input_sent") {
        throw new Error(`Unerwartete Antwort: ${JSON.stringify(data)}`);
      }
    } catch (err) {
      console.error("Fehler beim Senden der Eingabe:", err);
      notify(`Fehler beim Senden der Eingabe: ${err.message}`, "#cc0000");
    }
  }

  async function checkServerIsNewest() {
    try {
      const res = await fetch("/server/is_newest", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      return data.is_client_newest === true;
    } catch (err) {
      console.error("Fehler beim √úberpr√ºfen des Host-Status:", err);
      notify(`Fehler beim √úberpr√ºfen des Host-Status: ${err.message}`, "#cc0000");
      return false;
    }
  }

  async function uploadServer() {
    try {
      const res = await fetch("/server/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (data.status !== "server_uploaded") {
        throw new Error(`Unerwartete Antwort: ${JSON.stringify(data)}`);
      }
      notify("Server erfolgreich hochgeladen", "#228833");
      return true;
    } catch (err) {
      console.error("Fehler beim Hochladen des Servers:", err);
      notify(`Fehler beim Hochladen des Servers: ${err.message}`, "#cc0000");
      return false;
    }
  }

  async function setMaintenanceMode() {
    try {
      const res = await fetch("/server/set_new_maintenance", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (data.error) {
        throw new Error(data.error);
      }
      return true;
    } catch (err) {
      console.error("Fehler beim Aktivieren des Wartungsmodus:", err);
      notify(`Fehler beim Aktivieren des Wartungsmodus: ${err.message}`, "#cc0000");
      return false;
    }
  }

  async function getNewestHost() {
    try {
      const res = await fetch("/server/newest_host", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      return data.newest_host || null;
    } catch (err) {
      console.error("Fehler beim Abrufen des neuesten Hosts:", err);
      notify(`Fehler beim Abrufen des neuesten Hosts: ${err.message}`, "#cc0000");
      return null;
    }
  }

  async function addRcloneConfig(config) {
    try {
      const res = await fetch("/add_endpoints", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ config })
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (data.error) {
        throw new Error(data.error);
      }
      return true;
    } catch (err) {
      console.error("Fehler beim Hinzuf√ºgen der Rclone-Konfiguration:", err);
      notify(`Fehler beim Hinzuf√ºgen der Rclone-Konfiguration: ${err.message}`, "#cc0000");
      return false;
    }
  }

  function enterMaintenanceMode() {
    maintenanceMode = true;
    maintenanceBtn.textContent = "Upload";
    enableMaintenanceBtn();
    disableStartStop();
    disableConfigure();
    disableDeleteServer();
    disableServerControls();
    disablePredefinedButtons();
    notify("Wartungsmodus aktiviert", "#0066cc");
  }

  function exitMaintenanceMode() {
    maintenanceMode = false;
    maintenanceBtn.textContent = "Maintenance";
    if (serverSelect.value && endpointSelect.value) {
      if (!serverIsRunning) {
        enableStartStop();
        enableConfigure();
        enableDeleteServer();
        enableServerControls();
        enableMaintenance();
      }
      loadServerConfig(endpointSelect.value, serverSelect.value);
    } else {
      enableServerControls();
      enableMaintenance();
    }
  }

  async function tryStartServer() {
    try {
      const res = await fetch("/server/start", { method: "POST" });
      const data = await res.json();
      if (data.error) {
        if (data.error === "server_not_uploaded") {
          const isNewest = await checkServerIsNewest();
          if (isNewest) {
            const shouldUpload = window.confirm("Der Server wurde extern geschlossen. M√∂chten Sie den Server jetzt hochladen?");
            if (!shouldUpload) {
              notify("Serverstart abgebrochen aufgrund des nicht hochgeladenen Zustands", "#cc0000");
              return false;
            }
            const uploaded = await uploadServer();
            if (!uploaded) {
              return false;
            }
            // Retry starting the server after successful upload
            const retryRes = await fetch("/server/start", { method: "POST" });
            const retryData = await retryRes.json();
            if (retryData.error) {
              notify(`Fehler beim Starten nach Upload: ${retryData.error}`, "#cc0000");
              return false;
            }
            notify("Server gestartet ‚úÖ", "#228833");
            return true;
          } else {
            notify(`Fehler beim Starten: ${data.error}`, "#cc0000");
            return false;
          }
        } else {
          notify(`Fehler beim Starten: ${data.error}`, "#cc0000");
          return false;
        }
      }
      notify("Server gestartet ‚úÖ", "#228833");
      return true;
    } catch (err) {
      notify(`Netzwerkfehler beim Starten: ${err.message}`, "#cc0000");
      return false;
    }
  }

  function initializeWebSocket() {
    ws = new WebSocket(`ws://${window.location.host}/ws`);
    
    ws.onopen = () => {
      notify("WebSocket-Verbindung hergestellt", "#228833");
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.console) {
          if (Array.isArray(data.console)) {
            data.console.forEach(line => addToTerminal(line, true));
          } else if (typeof data.console === "string") {
            addToTerminal(data.console, true);
          }
        } else if (data.info) {
          if (data.info === "server_active") {
            updateStartStopUI(true);
            notify("Server ist aktiv", "#228833");
          } else if (data.info === "server_stopped") {
            updateStartStopUI(false);
            notify("Server gestoppt", "#228833");
          }
        } else if (data.restic && data.restic.message_type === "status") {
          const isUpload = "bytes_done" in data.restic;
          const type = isUpload ? "upload" : "download";
          const percent = Math.round(data.restic.percent_done * 100);
          
          if (!ongoingTransfers[type]) {
            const message = `${isUpload ? "Upload" : "Download"} gestartet: ${percent}%`;
            const notifId = notify(message, "#228833", true);
            ongoingTransfers[type] = { notifId, percent };
          } else {
            ongoingTransfers[type].percent = percent;
            updateNotification(ongoingTransfers[type].notifId, `${isUpload ? "Upload" : "Download"} gestartet: ${percent}%`);
          }
        } else if (data.restic && data.restic.message_type === "summary") {
          const isUpload = "bytes_done" in data.restic || "total_bytes_processed" in data.restic;
          const type = isUpload ? "upload" : "download";
          if (ongoingTransfers[type]) {
            notify(`${isUpload ? "Upload" : "Download"} abgeschlossen`, "#228833");
            delete ongoingTransfers[type];
          }
        }
      } catch (err) {
        console.error("Fehler beim Parsen der WebSocket-Nachricht:", err);
        notify("Fehler bei WebSocket-Daten", "#cc0000");
      }
    };

    ws.onclose = () => {
      notify("WebSocket-Verbindung geschlossen. Versuche erneut zu verbinden...", "#cc0000");
      setTimeout(initializeWebSocket, 5000);
    };

    ws.onerror = (err) => {
      console.error("WebSocket-Fehler:", err);
      notify("WebSocket-Fehler aufgetreten", "#cc0000");
    };
  }

  sendBtn.addEventListener("click", async () => {
    const text = input.value.trim();
    if (text) {
      addToTerminal(`> ${text}`, true);
      await sendInputToServer(text);
      input.value = "";
    }
  });

  input.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      const text = input.value.trim();
      if (text) {
        addToTerminal(`> ${text}`, true);
        await sendInputToServer(text);
        input.value = "";
      }
    }
  });

  function onClick(name) {
    addToTerminal(`[Clicked] ${name}`);
    notify(`Aktion ausgef√ºhrt: ${name}`, "#4444ff");
  }

  // Notifications
  const toast = document.getElementById("notificationToast");
  const notifToggle = document.getElementById("toggleNotifications");
  const notifPanel = document.getElementById("notificationPanel");
  const notifList = document.getElementById("notificationList");
  let notificationCache = [];
  let notificationQueue = [];
  let showingNotification = false;
  let panelOpen = false;

  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  function notify(message, color = "#333", isProgress = false) {
    const timestamp = new Date().toLocaleTimeString();
    const id = generateId();
    const entry = { id, message, timestamp, color, isProgress };
    const last = notificationCache[notificationCache.length - 1];
    if (last && last.message === message && last.timestamp === timestamp && last.color === color && !isProgress) {
      return id;
    }
    notificationCache.unshift(entry);
    if (panelOpen) {
      updatePanel();
    } else {
      notificationQueue.push(entry);
      processQueue();
    }
    return id;
  }

  function updateNotification(id, newMessage) {
    const entry = notificationCache.find(n => n.id === id);
    if (entry) {
      entry.message = newMessage;
      if (panelOpen) {
        updatePanel();
      }
    }
  }

  function createNotificationElement(entry) {
    const div = document.createElement("div");
    div.className = "notification-item";
    div.textContent = `[${entry.timestamp}] ${entry.message}`;
    div.style.backgroundColor = entry.color || "#333";
    div.dataset.id = entry.id;
    return div;
  }

  function updatePanel() {
    notifList.innerHTML = "";
    notificationCache.forEach(entry => {
      notifList.appendChild(createNotificationElement(entry));
    });
  }

  async function processQueue() {
    if (showingNotification || panelOpen || notificationQueue.length === 0) return;
    showingNotification = true;
    const entry = notificationQueue.shift();
    toast.textContent = `[${entry.timestamp}] ${entry.message}`;
    toast.style.backgroundColor = entry.color || "#333";
    toast.classList.remove("hidden");
    await new Promise(res => setTimeout(res, 3000));
    toast.classList.add("hidden");
    showingNotification = false;
    if (!panelOpen && notificationQueue.length > 0) {
      setTimeout(processQueue, 0);
    }
  }

  notifToggle.addEventListener("click", () => {
    panelOpen = !panelOpen;
    notifPanel.classList.toggle("hidden", !panelOpen);
    if (panelOpen) {
      updatePanel();
    } else {
      processQueue();
    }
  });

  const startStopBtn = document.getElementById("startStopBtn");
  const configureBtn = document.getElementById("configureBtn");
  const serverSelect = document.getElementById("serverSelect");
  const serverAddBtn = document.getElementById("serverAddBtn");
  const endpointSelect = document.getElementById("endpointSelect");
  const predefinedContainer = document.getElementById("predefinedInputs");
  const deleteServerBtn = document.getElementById("deleteServerBtn");
  const maintenanceBtn = document.getElementById("maintenanceBtn");

  function setStartStopText(text) {
    startStopBtn.textContent = text;
  }

  function setStartStopColor(hex) {
    startStopBtn.style.backgroundColor = hex;
  }

  function disableStartStop() {
    startStopBtn.disabled = true;
    startStopBtn.style.opacity = "0.5";
  }

  function enableStartStop() {
    startStopBtn.disabled = false;
    startStopBtn.style.opacity = "1";
  }

  function enableMaintenanceBtn() {
    maintenanceBtn.disabled = false;
    maintenanceBtn.style.opacity = "1";
  }

  function disableConfigure() {
    configureBtn.disabled = true;
    configureBtn.style.opacity = "0.5";
  }

  function enableConfigure() {
    configureBtn.disabled = false;
    configureBtn.style.opacity = "1";
  }

  function disableServerControls() {
    serverSelect.disabled = true;
    serverAddBtn.disabled = true;
    endpointSelect.disabled = true;
    document.querySelector(".add-btn[onclick=\"openEndpointCreateModal()\"]").disabled = true;
    serverSelect.style.opacity = "0.5";
    serverAddBtn.style.opacity = "0.5";
    endpointSelect.style.opacity = "0.5";
    document.querySelector(".add-btn[onclick=\"openEndpointCreateModal()\"]").style.opacity = "0.5";
  }

  function enableServerControls() {
    serverSelect.disabled = false;
    serverAddBtn.disabled = false;
    endpointSelect.disabled = false;
    document.querySelector(".add-btn[onclick=\"openEndpointCreateModal()\"]").disabled = false;
    serverSelect.style.opacity = "1";
    serverAddBtn.style.opacity = "1";
    endpointSelect.style.opacity = "1";
    document.querySelector(".add-btn[onclick=\"openEndpointCreateModal()\"]").style.opacity = "1";
  }

  function disablePredefinedButtons() {
    const buttons = predefinedContainer.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
    });
  }

  function enablePredefinedButtons() {
    const buttons = predefinedContainer.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = "1";
    });
  }

  function disableDeleteServer() {
    deleteServerBtn.disabled = true;
    deleteServerBtn.style.opacity = "0.5";
  }

  function enableDeleteServer() {
    deleteServerBtn.disabled = false;
    deleteServerBtn.style.opacity = "1";
  }

  function disableMaintenance() {
    maintenanceBtn.disabled = true;
    maintenanceBtn.style.opacity = "0.5";
  }

  function enableMaintenance() {
    maintenanceBtn.disabled = false;
    maintenanceBtn.style.opacity = "1";
  }

  function setPredefinedButtons(buttonDefinitions) {
    predefinedContainer.innerHTML = "";
    if (!buttonDefinitions || buttonDefinitions.length === 0) {
      const message = document.createElement("div");
      message.textContent = "Keine Befehle verf√ºgbar";
      message.style.color = "#aaa";
      message.style.padding = "10px";
      predefinedContainer.appendChild(message);
      return;
    }
    buttonDefinitions.forEach(cmd => {
      const btn = document.createElement("button");
      btn.textContent = cmd.name;
      btn.disabled = !serverIsRunning || maintenanceMode;
      btn.style.opacity = (serverIsRunning && !maintenanceMode) ? "1" : "0.5";
      btn.onclick = () => openArgumentModal(cmd);
      predefinedContainer.appendChild(btn);
    });
  }

  function setEndpointOptions(endpoints) {
    endpointSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.disabled = true;
    placeholder.selected = true;
    placeholder.hidden = true;
    placeholder.textContent = "Bitte Endpoint ausw√§hlen";
    endpointSelect.appendChild(placeholder);
    endpoints.forEach(endpoint => {
      const option = document.createElement("option");
      option.value = endpoint;
      option.textContent = endpoint;
      endpointSelect.appendChild(option);
    });
  }

  function setServerOptions(servers) {
    serverSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.disabled = true;
    placeholder.selected = true;
    placeholder.hidden = true;
    placeholder.textContent = "Bitte Server ausw√§hlen";
    serverSelect.appendChild(placeholder);
    servers.forEach(server => {
      const option = document.createElement("option");
      option.value = server;
      option.textContent = server;
      serverSelect.appendChild(option);
    });
  }

  // Modal Handling
  const configModalOverlay = document.getElementById("configModalOverlay");
  const serverConfigForm = document.getElementById("serverConfigForm");
  const serverConfigCancel = document.getElementById("serverConfigCancel");
  const serverConfigCommands = document.getElementById("serverConfigCommands");

  function addCommandSection(containerId) {
    const commandSection = document.createElement("div");
    commandSection.className = "command-section";
    commandSection.innerHTML = `
      <h4>Command</h4>
      <label for="cmd-name">Name</label>
      <input type="text" name="cmd-name" required>
      <label for="cmd-description">Description</label>
      <input type="text" name="cmd-description" required>
      <label for="cmd-command">Command</label>
      <input type="text" name="cmd-command" required>
      <div class="arguments-container"></div>
      <button type="button" class="add-btn-small" onclick="addArgumentSection(this)">+ Argument</button>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Command entfernen</button>
    `;
    document.getElementById(containerId).appendChild(commandSection);
  }

  function addArgumentSection(button) {
    const commandSection = button.parentElement;
    const argsContainer = commandSection.querySelector(".arguments-container");
    const argSection = document.createElement("div");
    argSection.className = "argument-section";
    argSection.innerHTML = `
      <h4>Argument</h4>
      <label for="arg-name">Name</label>
      <input type="text" name="arg-name" required>
      <label for="arg-type">Type</label>
      <select name="arg-type" required>
        <option value="String">String</option>
        <option value="int">Int</option>
      </select>
      <label for="arg-optional">Optional</label>
      <select name="arg-optional" required>
        <option value="false">Required</option>
        <option value="true">Optional</option>
      </select>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Argument entfernen</button>
    `;
    argsContainer.appendChild(argSection);
  }

  async function openServerConfigModal() {
    const selectedServer = serverSelect.value;
    const selectedEndpoint = endpointSelect.value;

    if (!selectedServer || !selectedEndpoint) {
      notify("Bitte w√§hlen Sie einen Server aus", "#cc0000");
      return;
    }

    try {
      const res = await fetch("/server/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          endpoint: selectedEndpoint,
          server_name: selectedServer
        })
      });

      if (!res.ok) throw new Error(`Status ${res.status}`);
      const config = await res.json();
      if (config.error) throw new Error(config.error);

      document.getElementById("serverConfigStartCmdWin").value = config.start_cmd_win || "";
      document.getElementById("serverConfigStartCmdLinux").value = config.start_cmd_linux || "";
      document.getElementById("serverConfigStopCmd").value = config.stop_cmd || "";
      document.getElementById("serverConfigPort").value = config.forward_port || "";
      document.getElementById("serverConfigEnv").value = config.env ? JSON.stringify(config.env, null, 2) : "";

      serverConfigCommands.innerHTML = "";
      (config.commands || []).forEach(cmd => {
        addCommandSection("serverConfigCommands");
        const section = serverConfigCommands.lastChild;
        section.querySelector("[name='cmd-name']").value = cmd.name;
        section.querySelector("[name='cmd-description']").value = cmd.description;
        section.querySelector("[name='cmd-command']").value = cmd.command;
        (cmd.arguments || []).forEach(arg => {
          addArgumentSection(section.querySelector(".add-btn-small"));
          const argSection = section.querySelector(".arguments-container").lastChild;
          argSection.querySelector("[name='arg-name']").value = arg.name;
          argSection.querySelector("[name='arg-type']").value = arg.type;
          argSection.querySelector("[name='arg-optional']").value = arg.optional.toString();
        });
      });

      configModalOverlay.classList.remove("hidden");
    } catch (err) {
      console.error("Fehler beim Laden der Serverkonfiguration:", err);
      notify(`Fehler beim Laden der Serverkonfiguration: ${err.message}`, "#cc0000");
    }
  }

  serverConfigForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!serverConfigForm.checkValidity()) {
      serverConfigForm.reportValidity();
      return;
    }

    const selectedServer = serverSelect.value;
    const selectedEndpoint = endpointSelect.value;

    const formData = new FormData(serverConfigForm);
    const data = {
      server_name: selectedServer,
      endpoint: selectedEndpoint,
      start_cmd_win: formData.get("start_cmd_win") || "",
      start_cmd_linux: formData.get("start_cmd_linux") || "",
      stop_cmd: formData.get("stop_cmd") || "",
      forward_port: parseInt(formData.get("port")),
      env: formData.get("env") ? JSON.parse(formData.get("env")) : {},
      commands: []
    };

    const commandSections = serverConfigCommands.querySelectorAll(".command-section");
    commandSections.forEach(section => {
      const command = {
        name: section.querySelector("[name='cmd-name']").value,
        description: section.querySelector("[name='cmd-description']").value,
        command: section.querySelector("[name='cmd-command']").value,
        arguments: []
      };
      const argSections = section.querySelectorAll(".argument-section");
      argSections.forEach(arg => {
        command.arguments.push({
          name: arg.querySelector("[name='arg-name']").value,
          type: arg.querySelector("[name='arg-type']").value,
          optional: arg.querySelector("[name='arg-optional']").value === "true"
        });
      });
      data.commands.push(command);
    });

    try {
      const res = await fetch("/server/config/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`HTTP Status ${res.status}`);
      const result = await res.json();
      if (result.error) {
        notify(`Fehler beim Speichern der Konfiguration: ${result.error}`, "#cc0000");
      } else {
        configModalOverlay.classList.add("hidden");
        notify(`Serverkonfiguration f√ºr ${selectedServer} gespeichert`, "#228833");
        setPredefinedButtons(data.commands);
      }
    } catch (err) {
      console.error("Fehler beim Speichern der Serverkonfiguration:", err);
      notify(`Fehler beim Speichern der Konfiguration: ${err.message}`, "#cc0000");
    }
  });

  configModalOverlay.addEventListener("click", (e) => {
    if (e.target === configModalOverlay) {
      configModalOverlay.classList.add("hidden");
    }
  });

  serverConfigCancel.addEventListener("click", () => {
    configModalOverlay.classList.add("hidden");
  });

  const argumentModalOverlay = document.getElementById("argumentModalOverlay");
  const argumentModal = document.getElementById("argumentModal");
  const argumentForm = document.getElementById("argumentForm");
  const argumentTitle = document.getElementById("argumentModalTitle");
  const argumentSubmit = document.getElementById("argumentSubmit");
  const argumentCancel = document.getElementById("argumentCancel");
  let currentCommandData = null;

  function openArgumentModal(commandData) {
    currentCommandData = commandData;

    if (!commandData.arguments || commandData.arguments.length === 0) {
      sendInputToTerminal(commandData, {});
      return;
    }

    argumentForm.innerHTML = "";
    argumentTitle.textContent = `Befehl: ${commandData.name}`;

    commandData.arguments.forEach(arg => {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "10px";

      const label = document.createElement("label");
      label.textContent = `${arg.name} (${arg.type})${arg.optional ? " [optional]" : ""}`;
      label.style.display = "block";
      label.style.marginBottom = "4px";

      const input = document.createElement("input");
      input.name = arg.name;
      input.required = !arg.optional;
      input.type = arg.type === "int" ? "number" : "text";
      input.style.width = "100%";
      input.style.padding = "6px";
      input.style.borderRadius = "4px";
      input.style.border = "1px solid #555";
      input.style.backgroundColor = "#222";
      input.style.color = "#fff";

      wrapper.appendChild(label);
      wrapper.appendChild(input);
      argumentForm.appendChild(wrapper);
    });

    argumentModalOverlay.classList.remove("hidden");
  }

  async function sendInputToTerminal(commandData, args) {
    const quotedArgs = Object.values(args).map(val => {
      return /\s/.test(val) ? `"${val}"` : val;
    });
    const fullCommand = [commandData.command, ...quotedArgs].join(" ");
    addToTerminal(`> ${fullCommand}`, true);
    await sendInputToServer(fullCommand);
    argumentModalOverlay.classList.add("hidden");
  }

  function handleArgumentSubmit(e) {
    e.preventDefault();
    if (!argumentForm.checkValidity()) {
      argumentForm.reportValidity();
      return;
    }

    const formData = new FormData(argumentForm);
    const args = {};
    for (const [key, value] of formData.entries()) {
      args[key] = value;
    }

    if (currentCommandData) {
      sendInputToTerminal(currentCommandData, args);
    }
  }

  argumentForm.addEventListener("submit", handleArgumentSubmit);
  argumentSubmit.addEventListener("click", handleArgumentSubmit);

  argumentModalOverlay.addEventListener("click", (e) => {
    if (e.target === argumentModalOverlay) {
      argumentModalOverlay.classList.add("hidden");
    }
  });

  argumentCancel.addEventListener("click", () => {
    argumentModalOverlay.classList.add("hidden");
  });

  const serverCreateModalOverlay = document.getElementById("serverCreateModalOverlay");
  const serverCreateForm = document.getElementById("serverCreateForm");
  const serverCreateCancel = document.getElementById("serverCreateCancel");
  const serverCreateCommands = document.getElementById("serverCreateCommands");

  function openServerCreateModal() {
    fetchEndpointsForServerCreate();
    serverCreateForm.reset();
    serverCreateCommands.innerHTML = "";
    serverCreateModalOverlay.classList.remove("hidden");
  }

  async function fetchEndpointsForServerCreate() {
    try {
      const res = await fetch(`/endpoints`);
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        const serverCreateEndpoint = document.getElementById("serverCreateEndpoint");
        serverCreateEndpoint.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.disabled = true;
        placeholder.selected = true;
        placeholder.hidden = true;
        placeholder.textContent = "Bitte Endpoint ausw√§hlen";
        serverCreateEndpoint.appendChild(placeholder);
        data.forEach(endpoint => {
          const option = document.createElement("option");
          option.value = endpoint;
          option.textContent = endpoint;
          serverCreateEndpoint.appendChild(option);
        });
      } else {
        notify("Ung√ºltiges Format von /endpoints", "#cc0000");
      }
    } catch (err) {
      console.error("Fehler beim Laden der Endpoints:", err);
      notify("Fehler beim Laden der Endpoints", "#cc0000");
    }
  }

  serverCreateForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!serverCreateForm.checkValidity()) {
      serverCreateForm.reportValidity();
      return;
    }

    const formData = new FormData(serverCreateForm);
    const data = {
      server_name: formData.get("server_name"),
      endpoint: formData.get("endpoint"),
      start_cmd_win: formData.get("start_cmd_win") || "",
      start_cmd_linux: formData.get("start_cmd_linux") || "",
      stop_cmd: formData.get("stop_cmd") || "",
      forward_port: parseInt(formData.get("port")),
      env: formData.get("env") ? JSON.parse(formData.get("env")) : {},
      commands: []
    };

    const commandSections = serverCreateCommands.querySelectorAll(".command-section");
    commandSections.forEach(section => {
      const command = {
        name: section.querySelector("[name='cmd-name']").value,
        description: section.querySelector("[name='cmd-description']").value,
        command: section.querySelector("[name='cmd-command']").value,
        arguments: []
      };
      const argSections = section.querySelectorAll(".argument-section");
      argSections.forEach(arg => {
        command.arguments.push({
          name: arg.querySelector("[name='arg-name']").value,
          type: arg.querySelector("[name='arg-type']").value,
          optional: arg.querySelector("[name='arg-optional']").value === "true"
        });
      });
      data.commands.push(command);
    });

    try {
      const res = await fetch("/server/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`HTTP Status ${res.status}`);
      const result = await res.json();
      if (result.error) {
        notify(`Fehler beim Erstellen des Servers: ${result.error}`, "#cc0000");
      } else {
        serverCreateModalOverlay.classList.add("hidden");
        notify(`Server ${data.server_name} erstellt`, "#228833");
        const serverEndpoint = data.endpoint;
        if (serverEndpoint) {
          try {
            const serverRes = await fetch(`/servers?endpoint=${encodeURIComponent(serverEndpoint)}`);
            if (serverRes.ok) {
              const servers = await serverRes.json();
              if (Array.isArray(servers)) {
                setServerOptions(servers);
                if (endpointSelect.value === serverEndpoint && !serverIsRunning) {
                  enableServerControls();
                }
              } else {
                notify("Ung√ºltige Serverdaten beim Aktualisieren der Liste", "#cc0000");
              }
            } else {
              notify("Fehler beim Aktualisieren der Serverliste", "#cc0000");
            }
          } catch (err) {
            console.error("Fehler beim Aktualisieren der Serverliste:", err);
            notify("Fehler beim Aktualisieren der Serverliste", "#cc0000");
          }
        }
      }
    } catch (err) {
      console.error("Fehler beim Erstellen des Servers:", err);
      notify(`Fehler beim Erstellen des Servers: ${err.message || "Unbekannter Fehler"}`, "#cc0000");
    }
  });

  serverCreateCancel.addEventListener("click", () => {
    serverCreateModalOverlay.classList.add("hidden");
  });

  serverCreateModalOverlay.addEventListener("click", (e) => {
    if (e.target === serverCreateModalOverlay) {
      serverCreateModalOverlay.classList.add("hidden");
    }
  });

  const endpointCreateModalOverlay = document.getElementById("endpointCreateModalOverlay");
  const endpointCreateForm = document.getElementById("endpointCreateForm");
  const endpointCreateCancel = document.getElementById("endpointCreateCancel");

  function openEndpointCreateModal() {
    endpointCreateForm.reset();
    endpointCreateModalOverlay.classList.remove("hidden");
  }

  endpointCreateForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!endpointCreateForm.checkValidity()) {
      endpointCreateForm.reportValidity();
      return;
    }

    const config = document.getElementById("endpointCreateConfig").value;
    const success = await addRcloneConfig(config);
    if (success) {
      endpointCreateModalOverlay.classList.add("hidden");
      await fetchEndpoints();
      notify("Endpunkte erfolgreich hinzugef√ºgt", "#228833");
    }
  });

  endpointCreateCancel.addEventListener("click", () => {
    endpointCreateModalOverlay.classList.add("hidden");
  });

  endpointCreateModalOverlay.addEventListener("click", (e) => {
    if (e.target === endpointCreateModalOverlay) {
      endpointCreateModalOverlay.classList.add("hidden");
    }
  });

  async function confirmDeleteServer() {
    const selectedServer = serverSelect.value;
    const selectedEndpoint = endpointSelect.value;

    if (!selectedServer || !selectedEndpoint) {
      notify("Bitte w√§hlen Sie einen Server aus", "#cc0000");
      return;
    }

    if (!window.confirm(`M√∂chten Sie den Server "${selectedServer}" wirklich l√∂schen?`)) {
      return;
    }

    try {
      const res = await fetch("/server/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          endpoint: selectedEndpoint,
          server_name: selectedServer
        })
      });
      if (!res.ok) throw new Error(`HTTP Status ${res.status}`);
      const result = await res.json();
      if (result.status === "server_deleted") {
        notify(`Server ${selectedServer} gel√∂scht`, "#228833");
        serverSelect.value = "";
        setPredefinedButtons([]);
        disablePredefinedButtons();
        disableStartStop();
        disableConfigure();
        disableDeleteServer();
        disableMaintenance();
        try {
          const serverRes = await fetch(`/servers?endpoint=${encodeURIComponent(selectedEndpoint)}`);
          if (serverRes.ok) {
            const servers = await serverRes.json();
            if (Array.isArray(servers)) {
              setServerOptions(servers);
            } else {
              notify("Ung√ºltige Serverdaten beim Aktualisieren der Liste", "#cc0000");
            }
          } else {
            notify("Fehler beim Aktualisieren der Serverliste", "#cc0000");
          }
        } catch (err) {
          console.error("Fehler beim Aktualisieren der Serverliste:", err);
          notify("Fehler beim Aktualisieren der Serverliste", "#cc0000");
        }
      } else {
        notify(`Fehler beim L√∂schen des Servers: Unerwartete Antwort`, "#cc0000");
      }
    } catch (err) {
      console.error("Fehler beim L√∂schen des Servers:", err);
      notify(`Fehler beim L√∂schen des Servers: ${err.message}`, "#cc0000");
    }
  }

  async function handleMaintenanceClick() {
    if (maintenanceMode) {
      // In maintenance mode, button is "Upload"
      const uploaded = await uploadServer();
      if (uploaded) {
        exitMaintenanceMode();
        notify("Wartungsmodus beendet, Server hochgeladen", "#228833");
      }
    } else {
      // Enter maintenance mode
      const success = await setMaintenanceMode();
      if (success) {
        enterMaintenanceMode();
      }
    }
  }

  maintenanceBtn.addEventListener("click", handleMaintenanceClick);

  async function fetchEndpoints() {
    try {
      const res = await fetch(`/endpoints`);
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        setEndpointOptions(data);
      } else {
        notify("Ung√ºltiges Format von /endpoints", "#cc0000");
      }
    } catch (err) {
      console.error("Fehler beim Laden der Endpoints:", err);
      notify("Fehler beim Laden der Endpoints", "#cc0000");
    }
  }

  async function loadInitialConfig() {
    try {
      const res = await fetch("/config/get");
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const config = await res.json();

      // Always fetch endpoints to populate the dropdown
      await fetchEndpoints();

      if (config.endpoint) {
        endpointSelect.value = config.endpoint;
        if (config.server_name) {
          try {
            const serverRes = await fetch(`/servers?endpoint=${encodeURIComponent(config.endpoint)}`);
            if (!serverRes.ok) throw new Error(`Status ${serverRes.status}`);
            const servers = await serverRes.json();
            if (Array.isArray(servers)) {
              setServerOptions(servers);
              serverSelect.value = config.server_name;
              if (servers.includes(config.server_name)) {
                await loadServerConfig(config.endpoint, config.server_name);
                // Check maintenance mode
                const newestHost = await getNewestHost();
                if (newestHost && newestHost.status === "maintenance") {
                  const isNewest = await checkServerIsNewest();
                  if (isNewest) {
                    enterMaintenanceMode();
                    notify("Wartungsmodus aktiv", "#0066cc");
                  }
                }
              }
            } else {
              notify("Ung√ºltige Serverdaten", "#cc0000");
            }
          } catch (err) {
            console.error("Fehler beim Laden der Server:", err);
            notify("Fehler beim Laden der Server", "#cc0000");
          }
        }
      }

      // Enable server controls if no server is running and not in maintenance mode
      if (!serverIsRunning && !maintenanceMode) {
        enableServerControls();
        if (config.endpoint && config.server_name) {
          enableConfigure();
          enableDeleteServer();
          enableStartStop();
          enableMaintenance();
        }
      }
    } catch (err) {
      console.error("Fehler beim Laden der Konfiguration:", err);
      notify("Fehler beim Laden der Konfiguration", "#cc0000");
      // Still fetch endpoints to allow user selection
      await fetchEndpoints();
      if (!serverIsRunning && !maintenanceMode) {
        enableServerControls();
      }
    }
  }

  async function loadServerConfig(endpoint, serverName) {
    try {
      const res = await fetch("/server/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          endpoint: endpoint,
          server_name: serverName
        })
      });
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const serverConfig = await res.json();
      if (serverConfig.error) throw new Error(serverConfig.error);
      setPredefinedButtons(serverConfig.commands || []);
    } catch (err) {
      console.error("Fehler beim Laden der Serverkonfiguration:", err);
      notify(`Fehler beim Laden der Serverkonfiguration: ${err.message}`, "#cc0000");
      setPredefinedButtons([]);
    }
  }

  endpointSelect.addEventListener("change", async () => {
    const selectedEndpoint = endpointSelect.value;

    if (!selectedEndpoint) {
      setServerOptions([]);
      setPredefinedButtons([]);
      disablePredefinedButtons();
      disableStartStop();
      disableConfigure();
      disableDeleteServer();
      disableMaintenance();
      if (!serverIsRunning && !maintenanceMode) {
        enableServerControls();
      }
      return;
    }

    try {
      const res = await fetch(`/servers?endpoint=${encodeURIComponent(selectedEndpoint)}`);
      if (!res.ok) throw new Error(`Status ${res.status}`);
      const servers = await res.json();

      if (Array.isArray(servers)) {
        setServerOptions(servers);
        serverSelect.value = "";
        setPredefinedButtons([]);
        disablePredefinedButtons();
        disableStartStop();
        disableConfigure();
        disableDeleteServer();
        disableMaintenance();
        if (!serverIsRunning && !maintenanceMode) {
          enableServerControls();
        }
        notify(`Server f√ºr ${selectedEndpoint} geladen`, "#228833");
      } else {
        notify("Ung√ºltige Serverdaten", "#cc0000");
        setPredefinedButtons([]);
        disablePredefinedButtons();
        disableStartStop();
        disableConfigure();
        disableDeleteServer();
        disableMaintenance();
      }
    } catch (err) {
      console.error("Fehler beim Laden der Server:", err);
      notify("Fehler beim Laden der Server", "#cc0000");
      setServerOptions([]);
      setPredefinedButtons([]);
      disablePredefinedButtons();
      disableStartStop();
      disableConfigure();
      disableDeleteServer();
      disableMaintenance();
    }
  });

  serverSelect.addEventListener("change", async () => {
    const selectedServer = serverSelect.value;
    const selectedEndpoint = endpointSelect.value;

    if (!selectedServer || !selectedEndpoint) {
      setPredefinedButtons([]);
      disablePredefinedButtons();
      disableStartStop();
      disableConfigure();
      disableDeleteServer();
      disableMaintenance();
      return;
    }

    try {
      const configRes = await fetch("/config/get");
      if (!configRes.ok) throw new Error("Fehler beim Abrufen der Config");
      const config = await configRes.json();

      const postRes = await fetch("/config/set", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          client_id: config.client_id,
          endpoint: selectedEndpoint,
          server_name: selectedServer
        })
      });

      if (!postRes.ok) throw new Error("Fehler beim Speichern der Config");

      await loadServerConfig(selectedEndpoint, selectedServer);

      if (!serverIsRunning && !maintenanceMode) {
        enableStartStop();
        enableConfigure();
        enableDeleteServer();
        enableMaintenance();
      }
      // Check maintenance mode
      const newestHost = await getNewestHost();
      if (newestHost && newestHost.status === "maintenance") {
        const isNewest = await checkServerIsNewest();
        if (isNewest) {
          enterMaintenanceMode();
          notify("Wartungsmodus aktiv", "#0066cc");
        }
      }
      notify(`Konfiguration gespeichert und Befehle geladen: ${selectedServer} @ ${selectedEndpoint}`, "#228833");
    } catch (err) {
      console.error(err);
      notify(`Fehler beim Setzen der Konfiguration oder Laden der Befehle: ${err.message}`, "#cc0000");
      setPredefinedButtons([]);
      disablePredefinedButtons();
      disableStartStop();
      disableConfigure();
      disableDeleteServer();
      disableMaintenance();
    }
  });

  let serverIsRunning = false;

  async function updateStartStopUI(running) {
    serverIsRunning = running;
    startStopBtn.textContent = running ? "Stop" : "Start";
    startStopBtn.style.backgroundColor = running ? "#cc0000" : "#228833";
    if (!maintenanceMode) {
      enableStartStop();
      if (running) {
        enablePredefinedButtons();
        disableConfigure();
        disableDeleteServer();
        disableServerControls();
        disableMaintenance();
        if (endpointSelect.value && serverSelect.value) {
          await loadServerConfig(endpointSelect.value, serverSelect.value);
        }
      } else {
        disablePredefinedButtons();
        if (serverSelect.value && endpointSelect.value) {
          enableConfigure();
          enableDeleteServer();
          enableServerControls();
          enableMaintenance();
          await loadServerConfig(endpointSelect.value, serverSelect.value);
        } else {
          enableServerControls();
          enableMaintenance();
        }
      }
    }
  }

  startStopBtn.addEventListener("click", async () => {
    disableStartStop();
    disablePredefinedButtons();
    disableConfigure();
    disableDeleteServer();
    disableMaintenance();
    disableServerControls();

    if (!serverIsRunning) {
      const started = await tryStartServer();
      updateStartStopUI(started);
    } else {
      try {
        const res = await fetch("/server/stop", { method: "POST" });
        const data = await res.json();

        if (data.status === "server_stopped") {
          notify("Server gestoppt üõë", "#228833");
          updateStartStopUI(false);
        } else {
          notify("Fehler beim Stoppen", "#cc0000");
          updateStartStopUI(true);
        }
      } catch (err) {
        notify("Netzwerkfehler beim Stoppen", "#cc0000");
        updateStartStopUI(true);
      }
    }
  });

  // Initial State
  async function initialize() {
    setStartStopText("Start");
    setStartStopColor("#228833");
    disableStartStop();
    disableConfigure();
    disableDeleteServer();
    disableMaintenance();
    setPredefinedButtons([]);
    disablePredefinedButtons();
    await loadInitialConfig();
    initializeWebSocket();
  }

  initialize();
</script>
</body>
</html>